name: Update Cron in Workflow File

on:
  workflow_dispatch:
  
 # schedule:
  #  - cron: '32 8 * * 4'

jobs:
  update-cron:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}

      - name: Generate random minute and compute tomorrow's weekday
        id: cron_info
        run: |
          # 随机分钟 10-59
          MINUTE=$((10 + RANDOM % 50))
          
          # 获取今天是星期几（0=Sun, 1=Mon, ..., 6=Sat）
          TODAY_WEEKDAY=$(date -u +%w)  # UTC 星期
          
          # 计算明天的星期（0-6）
          TOMORROW_WEEKDAY=$(( (TODAY_WEEKDAY + 1) % 7 ))
          
          echo "minute=$MINUTE" >> $GITHUB_OUTPUT
          echo "weekday=$TOMORROW_WEEKDAY" >> $GITHUB_OUTPUT
          
          echo "Today (UTC): $(date -u)"
          echo "Today weekday (0=Sun): $TODAY_WEEKDAY"
          echo "Tomorrow weekday: $TOMORROW_WEEKDAY"

      - name: Replace cron line (line 7)
        env:
          NEW_MINUTE: ${{ steps.cron_info.outputs.minute }}
          NEW_WEEKDAY: ${{ steps.cron_info.outputs.weekday }}
        run: |
          FILE=".github/workflows/main.yml"
          if [ ! -f "$FILE" ]; then
            echo "❌ File not found!"
            exit 1
          fi

          # 构造 cron: "MINUTE 8 * * WEEKDAY"
          NEW_CRON="$NEW_MINUTE 8 * * $NEW_WEEKDAY"
          sed -i "7s/.*/    - cron: '$NEW_CRON'/" "$FILE"
          
          echo "✅ Updated cron line:"
          sed -n '7p' "$FILE"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --staged --quiet && exit 0
          git commit -m "chore: update cron to ${{ steps.cron_info.outputs.minute }} 8 * * ${{ steps.cron_info.outputs.weekday }}"
          git push
